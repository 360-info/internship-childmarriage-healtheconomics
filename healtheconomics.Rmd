---
title: "healthecon"
author: "Ambalika"
date: "2023-04-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r package}

library(readr)
library(readxl)
library(janitor)
library(tidyverse)
library(rnaturalearth)
library(ggplot2)
library(plotly)
library(themes360info)
library(rio)

```

```{r readdata}

# Reading HDI data

hdi <- read_csv("data/healtheconomics/hdi_timeseries.csv")

hdi <- hdi %>%
  pivot_longer(cols = 6:37,
               names_to = "year",
               values_to = "HDI")

hdi <- hdi %>%
  select(c(-region, -hdicode, -hdi_rank_2021)) %>%
  mutate(year = str_remove_all(year, "hdi_")) %>%
  mutate(year = as.numeric(year)) %>%
  filter(year > 2014)

# Reading WHR(World Happiness Record) data

whr <- read_excel("data/healtheconomics/wellbeing-otherfactos.xls")

whr <- whr %>%
  clean_names() %>%
  mutate(WHR = life_ladder / 10)

# Comparison data

comparisonf <- whr %>%
  left_join(hdi, by = c("country_name" = "country", "year"))

comparisonf <-
  merge(
    whr,
    hdi,
    by.x = c("country_name", "year"),
    by.y = c("country", "year")
  ) %>%
  select(country_name, year, 13:15)

comparison <- comparisonf %>%
  pivot_longer(cols = c(3, 5),
               names_to = "organisation",
               values_to = "score")

comparison$organisation[comparison$organisation == "WHR"] <-
  "Happiness Score"
comparison$organisation[comparison$organisation == "HDI"] <-
  "Human Development Index"

# For subcontinental comparison

subcon <- ne_countries(returnclass = "sf", scale = "medium") %>%
  select(admin, iso_a3, subregion, region_wb)

subcon <- merge(comparison, subcon, by.x = "iso3", by.y = "iso_a3")

southasia <- subcon %>%
  filter(subregion == "Southern Asia")

centralasia <- subcon %>%
  filter(subregion == "Central Asia")

westernasia <- subcon %>%
  filter(subregion == "Western Asia")

easternasia <- subcon %>%
  filter(subregion == "Eastern Asia")

seasia <- subcon %>%
  filter(subregion == "South-Eastern Asia")

ausnz <- subcon %>%
  filter(subregion == "Australia and New Zealand")

```

# South Asia Analysis

```{r southasia}

ggplotly(
  southasia %>%
    ggplot(aes(
      x = year,
      y = score,
      color = organisation
    )) +
    geom_line() +
    geom_point() +
    labs(title = "Wellbeing Economics in South Asia" , x = "Year", y = "Score") +
    theme(legend.position = "bottom") +
    theme_bw() +
    facet_wrap( ~ country_name,
                nrow = 4)
)


```

# Middle-East Asia Analysis

```{r middleeast}

ggplotly(
  westernasia %>%
    ggplot(aes(
      x = year,
      y = score,
      color = organisation
    )) +
    geom_line() +
    geom_point() +
    labs(title = "Wellbeing Economics in Middle-East Asia" , x = "Year", y = "Score") +
    theme(legend.position = "bottom") +
    theme_bw() +
    facet_wrap(~ country_name,
               ncol = 3)
)

```

# East Asia Analysis

```{r east}

ggplotly(
  easternasia %>%
    ggplot(aes(
      x = year,
      y = score,
      color = organisation
    )) +
    geom_line() +
    geom_point() +
    labs(title = "Wellbeing Economics in East Asia" , x = "Year", y = "Score") +
    theme(legend.position = "bottom") +
    theme_bw() +
    facet_wrap( ~ country_name,
                nrow = 4)
)

```

# South-East Asia analysis

```{r southeast}

ggplotly(
  seasia %>%
    ggplot(aes(
      x = year,
      y = score,
      color = organisation
    )) +
    geom_line() +
    geom_point() +
    labs(title = "Wellbeing Economics in South-East Asia" , x = "Year", y = "Score") +
    theme(legend.position = "bottom") +
    theme_bw() +
    facet_wrap( ~ country_name,
                ncol = 3)
)

```

# Pacific Region Analysis

```{r ausnz}

ggplotly(
  ausnz %>%
    ggplot(aes(
      x = year,
      y = score,
      color = organisation
    )) +
    geom_line() +
    geom_point() +
    labs(title = "Wellbeing Economics in Pacific Region" , x = "Year", y = "Score") +
    theme(legend.position = "bottom") +
    theme_bw() +
    facet_wrap(~ country_name,
               nrow = 4)
)

```


# Happiness Score Factors Data

```{r}

whrfactor <- import_list("data/healtheconomics/2015_a.xlsx" , rbind=TRUE)

whrfactor <- whrfactor %>% 
  select(-`_file`)

whrfactor <- whrfactor %>% 
  pivot_longer(
    cols = 2:9,
    names_to = "factor",
    values_to = "value"
  )


```


# Human Development Index Factors

```{r}

# Life Expectancy Data

le <- read_excel("data/healtheconomics/le.xlsx")

le <- le %>%
  pivot_longer(cols = 4:35,
               names_to = "year",
               values_to = "life_expectancy")

le <- le %>%
  select(c(-hdicode)) %>%
  mutate(year = str_remove_all(year, "le_")) %>%
  mutate(year = as.numeric(year)) %>%
  filter(year > 2014)


# Gross National Income Per Capita

gnipc <- read_excel("data/healtheconomics/gnipic.xlsx")

gnipc <- gnipc %>%
  pivot_longer(cols = 5:36,
               names_to = "year",
               values_to = "GNIPC")

gnipc <- gnipc %>%
  select(c(-hdicode)) %>%
  mutate(year = str_remove_all(year, "gnipc_")) %>%
  mutate(year = as.numeric(year)) %>%
  filter(year > 2014)

hdifactor <-
  inner_join(le, gnipc, by = c("year", "country", "iso3"))


# Expected years of Schooling

eys <- read_excel("data/healtheconomics/eys.xlsx")

eys <- eys %>%
  pivot_longer(cols = 5:36,
               names_to = "year",
               values_to = "eys")

eys <- eys %>%
  mutate(year = str_remove_all(year, "eys_")) %>%
  mutate(year = as.numeric(year)) %>%
  select(c(-hdicode)) %>%
  filter(year > 2014)

hdifactor <-
  inner_join(hdifactor, eys, by = c("year", "country", "iso3", "region"))


# Mean Years of Schooling

mys <- read_excel("data/healtheconomics/mys.xlsx")

mys <- mys %>%
  pivot_longer(cols = 5:36,
               names_to = "year",
               values_to = "mys")

mys <- mys %>%
  mutate(year = str_remove_all(year, "mys_")) %>%
  mutate(year = as.numeric(year)) %>%
  select(c(-hdicode)) %>%
  filter(year > 2014)

hdifactor <-
  inner_join(hdifactor, mys, by = c("year", "country", "iso3", "region"))

hdifactor <-
  inner_join(hdifactor, hdi, by = c("year", "country", "iso3"))

hdifactor <- hdifactor %>%
  mutate(logGNI = log(GNIPC)) %>%
  mutate(lifeexp = life_expectancy / 10) %>%
  select(-region,-GNIPC,-life_expectancy)

hdifactor <- hdifactor %>%
  pivot_longer(cols = 4:8,
               names_to = "factor",
               values_to = "value")

```

# Comparison of HDI and WHR with contributing factors

```{r}

a <- ggplotly(
  hdifactor %>% 
    filter(country == 
             'Indonesia') %>% 
    ggplot(aes(x = year, 
               y = value, 
               color = factor)) +
    geom_line() +
    geom_point() +
    theme_bw() +
    scale_color_brewer(palette = "Dark2")
)

b <- ggplotly(
  whrfactor %>% 
    filter(country == 
             'Indonesia') %>% 
    ggplot(aes(x = year, 
               y = value, 
               color = factor)) +
    geom_line() +
    geom_point() +
    theme_bw() +
    scale_color_brewer(palette = "Dark2")
)

subplot(a,b)

```


# WHR Factors - Stacked Bar Chart

```{r}

whrfac <- whrfactor %>%
  filter(factor != c("residual", "score"))

indonesiawhr <- whrfac %>%
  filter(country == "Pakistan")

indonesiascore <- whrfactor %>%
  filter(factor == "score", country == "Pakistan")

ggplotly(
  ggplot(indonesiawhr, aes(
    fill = factor, x = year, y = value
  )) +
    scale_fill_brewer(palette = "Paired") +
    geom_bar(position = "stack", stat = "identity") +
    labs(title = "World Happiness Score : Factor composition") +
    theme_bw() +
    theme(legend.position = "top") +
    geom_line(data = indonesiascore, aes(x = year, y = value)) +
    geom_point(data = indonesiascore)
)


```


# HDI vs WHR with life expectancy for Asia Pacific Region

```{r}

le2021 <-
  merge(comparisonf,
        le,
        by.x = c("iso3", "year"),
        by.y = c("iso3", "year")) %>%
  filter(year == 2021)

geo <- ne_countries(returnclass = "sf", scale = "medium") %>%
  select(admin, iso_a3, subregion, region_wb)

le2021 <- merge(le2021, geo, by.x = "iso3", by.y = "iso_a3")

le2021 <- le2021 %>%
  filter(
    subregion %in% c(
      "Southern Asia",
      "Central Asia",
      "Western Asia",
      "Eastern Asia",
      "South-Eastern Asia",
      "Australia and New Zealand"
    )
  )

ggplotly(
  ggplot(
    le2021,
    aes(
      x = HDI,
      y = WHR,
      size = life_expectancy,
      color = subregion,
      text = country_name
    )
  ) +
    labs(title = "HDI vs WHR with life expectancy for Asia Pacific Region") +
    geom_point(alpha = 0.5) +
    scale_size(range = c(.1, 12), name = "Subregion") +
    ylab("WHR") +
    xlab("HDI") +
    labs(title  = "Wellbeing") +
    scale_y_continuous(labels = scales::label_percent(scale = 1)) +
    scale_x_continuous(labels = scales::label_percent(scale = 1)) +
    scale_color_brewer(palette = "Dark2")
)

```






